---
title: "boxset"
author: "David Hugh-Jones"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{boxset}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---


# The skinny


```{r, include=FALSE}
library(rmarkdown)
library(knitr)
opts_chunk$set(results='markup', echo=TRUE)
knitr_options(opts_chunk=list(echo=TRUE, results='markup'))
```

Creating a refset:
```{r}
library(refset)
employees <- data.frame(
      id=1:4, 
      name=c("James", "Sylvia", "Meng Qi", "Luis"), 
      age=c(28,44,38, 23), 
      gender=factor(c("M", "F", "F", "M")), 
      stringsAsFactors=FALSE)
      
refset(rs, employees[1:2,])
```

Refsets refer to the original:
```{r}
rs
employees$name[1] <- "Jimmy"
rs
```

Refsets change the original:
```{r}
rs$age <- c(29, 45)
employees$age
```

Reassignment breaks the link:
```{r}
ss <- rs
employees$name[2] <- "Silvia"
rs$name[2]
ss$name[2]
```

You can have refsets of refsets:
```{r}
refset(rs2, rs$id)
rs2 
rs$id <- rs$id + 1000
rs2
rs2 <- 101:102
employees$id
rs$id
```

Refset size can change dynamically:
```{r}
# the multi-argument form. Note the empty argument, to select all columns:
refset(rsd, employees, age < 30, , drop=FALSE)
rsd
employees$age <- employees$age + 1
rsd
```

But you can turn this off:
```{r}
refset(rsd, employees, age < 40, , dyn.idx=FALSE)
rsd
employees$age <- employees$age + 1
rsd
```

You can have a refset of any subsettable object...

```{r}
vec <- 1:10
refset(rs, vec, 4:6)
rs <- rs*10
vec
```

... using any form of subsetting.
```{a}
lst <- list(a="text", b=42, NA)
refset(rsl, lst$b)
rsl <- "more text"
lst$b
```

For more general expressions, use a _reference_:

```{r}
montecarlo <- data.frame(x1=rnorm(10), x2=rnorm(10))
a <- 1
b <- 2
reference(dgp, transform(montecarlo, y=a*x1 + b*x2 + rnorm(nrow(montecarlo))))
dgp[1:2,] 
```

The expression is evaluated again each time the reference is called:
```{r}
dgp$y
dgp$y
replicate(10, coef(lm(y~x1+x2, data=dgp)))
```

References are read-only:
```{r}
dgp$x1 <- runif(10)
```



## Introduction

Normally, R uses "pass by value". This means that when you run
`b <- a` you have two independent copies of the same data. Similarly, the code:

```{r}
f <- function(x) {x <- x*2}
a <- 4
f(a)
a
```
does not change the value of `a`, since the function `f` gets passed the contents
of `a` rather than the variable `a` itself.

This is fine for most cases, especially for traditional uses of R in which
the programmer or statistician passes in a value to a function, and sees
the result on the command line. However, in some cases we would like to have a
single object being passed around. For example, if we have a long running web
server, we will want to have a single object representing this, not many
copies. Or, suppose you have a single data frame, and you would like to work on 
parts of it using standard data frame syntax, but to keep it synced with the
main data frame. 

The parcel package allows you to do this by creating objects that refer to other
objects, or subsets of them.





Reference classes (see `?ReferenceClasses`) and similar systems allow for this
by using R environments. But they don't fit very well with R's traditional
syntax. To take a subset of a reference object, you need to define your own 
methods. 




# problems with eval/substitute

# problem 1: passing into different contexts
f <- function(x) {
  sx <- substitute(x)
  g(sx)
}

g <- function(x) {
  myvalue <- "boo!"
  ex <- eval(x)
  cat(ex)
}

myvalue <- "I hope I don't get lost"
f(myvalue)

# See also Hadley's page

# problem 2: having to keep track of parents

g <- function(x) {
  myvalue <- "boo!"
  ex <- eval(x, parent.frame(2))
  cat(ex)
}

myvalue <- "doesn't get lost any more!"
f(myvalue)
# but now
h <- function(x) {sx <- substitute(x); f(sx)}
you_look_like_a_monkey <- "I feel like a banana"
h(you_look_like_a_monkey)

# the problem is

Vignettes are long form documentation commonly included in packages. Because they are part of the distribution of the package, they need to be as compact as possible. The `html_vignette` output type provides a custom style sheet (and tweaks some options) to ensure that the resulting html is as small as possible. The `html_vignette` format:

- Never uses retina figures
- Has a smaller default figure size
- Uses a custom CSS stylesheet instead of the default Twitter Bootstrap style

## Vignette Info

Note the various macros within the `vignette` setion of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the `title` field and the `\VignetteIndexEntry` to match the title of your vignette.

## Styles

The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows:

    output: 
      rmarkdown::html_vignette:
        css: mystyles.css

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r, fig.show='hold'}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))
